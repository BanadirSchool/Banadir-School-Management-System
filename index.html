<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Banadir School BEST </title>
  <link rel="icon" type="image/x-icon" href="BANADIR LOGO.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background: #f7fafc; }
    .card { border-radius: 12px; }
    .brand { font-weight:700; color:#92047a }
    .small-muted { font-size:0.85rem; color:#045aa5 }
    .dashboard-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap:1rem; color: #09a2ad; border-color: #3f0202; background-color: #49c9da;}
    section { display:none; }
    section.active { display:block; }
    .invoice-header { display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #570606; padding-bottom:10px; margin-bottom:15px; }
    .invoice-header h3 { margin:0; }
    .invoice-logo img { max-height:60px; }

    /* Buttons Custom Colors */
    .btn-primary { background: linear-gradient(to right, #3f0202, #06224d); border: none; color: #fff; }
    .btn-primary:hover { background-color: #5c053f; border-color: #092f70; }
    .btn-success { background-color: #042c04; border-color: #52033e; color:#fff; }
    .btn-success:hover { background-color: #6b0552; border-color: #0f3d10; }
    .btn-danger { background-color: #8b0000; border-color: #1b045a; color:#fff; }
    .btn-danger:hover { background-color: #5c0000; border-color: #5c0000; }
    .btn-outline-primary { color: #0b3d91; border-color: #0b3d91; }
    .btn-outline-primary:hover { background-color: #0b3c9185; color:#fff; }
    .btn-outline-secondary { color: #333; border-color: #09a2ad; }
    .btn-outline-secondary:hover { background-color: #0c667c94; color:#fff; }

    /* Print Styles */
    @media print {
      nav,
      #registrationForm,
      #paymentForm,
      #studentsList,
      #paymentsList,
      .dashboard-grid,
      .btn,
      #invoiceStartDate,
      #invoiceEndDate,
      section:not(#invoice) {
        display: none !important;
      }
      #invoice { display: block !important; }
      body { background: #550505 !important; margin:0; padding:0; }
      .invoice-header, #invoiceContent { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
    <h3>Banadir School BEST</h3>
          <div class="invoice-logo">
            <img src="BANADIR LOGO.jpg" alt="School Logo">
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand brand" href="#">Iskuul Manage</a>
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#" data-section="register">Diiwaangelin</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-section="payments">Lacag Qabasho</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-section="invoice">Invoice</a></li>
      </ul>
    </div>
  </nav>

  <div class="container">
    <!-- Register Section -->
    <section id="register" class="active">
      <!-- Registration form and student list (same as before) -->
      <div class="row">
        <div class="col-lg-8">
          <div class="card p-4 mb-4">
            <h4>Arday Diiwaangelin</h4>
            <form id="registrationForm" class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Magaca Hore</label>
                <input type="text" id="firstName" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Magaca Dambe</label>
                <input type="text" id="lastName" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Taleefan</label>
                <input type="text" id="phone" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Fasal</label>
                <select id="classSelect" class="form-select">
                  <option value="Grade 1">Grade 1</option>
                  <option value="Grade 2">Grade 2</option>
                  <option value="Grade 3">Grade 3</option>
                  <option value="Grade 3">Grade 4</option>
                  <option value="Grade 3">Grade 5</option>
                  <option value="Grade 3">Grade 6</option>
                  <option value="Grade 3">Grade 7</option>
                  <option value="Grade 3">Grade 8</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Lacagta Diiwaangelinta (USD)</label>
                <input type="number" id="fee" class="form-control" value="1">
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Diiwaangeli</button>
              </div>
            </form>
          </div>
          <div class="card p-4 mb-4">
            <h5>Liiska Ardayda</h5>
            <div id="studentsList"></div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card p-4 mb-3">
            <h6>Dashboard</h6>
            <div class="dashboard-grid mt-3">
              <div class="p-3 bg-white shadow-sm rounded text-center">
                <div class="small-muted">Arday</div>
                <div id="statStudents" class="h4 mt-1">0</div>
              </div>
              <div class="p-3 bg-white shadow-sm rounded text-center">
                <div class="small-muted">Lacag la qabtay (USD)</div>
                <div id="statPaid" class="h4 mt-1">0</div>
              </div>
              <div class="p-3 bg-white shadow-sm rounded text-center">
                <div class="small-muted">Pending</div>
                <div id="statPending" class="h4 mt-1">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Payments Section -->
    <section id="payments">
      <!-- Payment form and list -->
      <div class="card p-4 mb-4">
        <h4>Lacag Qabasho</h4>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <input type="text" id="searchName" class="form-control" placeholder="Raadi magaca ardayga">
          </div>
          <div class="col-md-4">
            <input type="date" id="searchDate" class="form-control">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="filterPayments()">Search</button>
          </div>
        </div>
        <form id="paymentForm" class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Magaca Ardayga</label>
            <select id="studentSelect" class="form-select"></select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Taariikh</label>
            <input type="date" id="paymentDate" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Lacagta (USD)</label>
            <input type="number" id="paymentAmount" class="form-control" required>
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-success">Add Payment</button>
          </div>
        </form>
      </div>
      <div class="card p-4">
        <h5>Liiska Lacagaha</h5>
        <div id="paymentsList"></div>
      </div>
    </section>

    <!-- Invoice Section -->
    <section id="invoice">
      <div class="card p-4">
        <div class="invoice-header">
          <h3>Banadir School BEST</h3>
          <div class="invoice-logo">
            <img src="BANADIR LOGO.jpg" alt="School Logo">
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <input type="text" id="invoiceSearchName" class="form-control" placeholder="Raadi magaca ardayga">
          </div>
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" id="invoiceStartDate" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" id="invoiceEndDate" class="form-control">
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="filterInvoice()">Search</button>
          </div>
        </div>

        <div id="invoiceContent" class="mb-3 small-muted">Dooro arday iyo taariikh si aad u aragto invoice...</div>
        <button class="btn btn-outline-secondary me-2" onclick="window.print()">Print Invoice</button>
        <button class="btn btn-outline-primary" onclick="downloadInvoicePDF()">Download PDF</button>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const STORAGE_KEY = 'school_demo_students_v10';

    function loadStudents(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ return []; } }
    function saveStudents(list){ localStorage.setItem(STORAGE_KEY,JSON.stringify(list)); }

    function renderStudents(){
      const list = loadStudents();
      const container = document.getElementById('studentsList');
      const statStudents = document.getElementById('statStudents');
      const statPaid = document.getElementById('statPaid');
      const statPending = document.getElementById('statPending');

      statStudents.textContent = list.length;
      statPaid.textContent = list.filter(s=>s.payments&&s.payments.length).reduce((a,b)=>a+b.payments.reduce((x,y)=>x+y.amount,0),0);
      statPending.textContent = list.filter(s=>!s.payments||!s.payments.length).length;

      if(!list.length){ container.innerHTML = '<div class="small-muted">Ma jiro arday la diiwaangeliyey</div>'; return; }

      let html = '<div class="list-group">';
      list.forEach((s,idx)=>{
        const totalPaid = s.payments?s.payments.reduce((a,b)=>a+b.amount,0):0;
        html+=`
        <div class="list-group-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-bold">${s.firstName} ${s.lastName}</div>
              <div class="small-muted">${s.email} • ${s.phone||'-'} • ${s.className}</div>
              <div class="small">Paid: $${totalPaid}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-success me-2" onclick="addMonthlyPayment(${idx})">Add Payment</button>
              <button class="btn btn-sm btn-outline-primary me-2" onclick="editStudent(${idx})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${idx})">Delete</button>
            </div>
          </div>
        </div>`;
      });
      html+='</div>';
      container.innerHTML=html;
      renderStudentSelect();
    }

    document.getElementById('registrationForm').addEventListener('submit',function(e){
      e.preventDefault();
      const firstName=document.getElementById('firstName').value.trim();
      const lastName=document.getElementById('lastName').value.trim();
      const email=document.getElementById('email').value.trim();
      const phone=document.getElementById('phone').value.trim();
      const className=document.getElementById('classSelect').value;
      const amount=Number(document.getElementById('fee').value)||0;
      const students=loadStudents();
      const newStudent={firstName,lastName,email,phone,className,payments:[{amount,date:new Date().toISOString()}],createdAt:new Date().toISOString()};
      students.push(newStudent);
      saveStudents(students);
      renderStudents();
      this.reset();
    });

    function deleteStudent(idx){
      const students=loadStudents();
      if(confirm('Ma hubtaa inaad tirtirayso ardaygan?')){
        students.splice(idx,1);
        saveStudents(students);
        renderStudents();
      }
    }

    function editStudent(idx){
      const students=loadStudents();
      const s=students[idx];
      const newFirst=prompt('Magaca Hore:',s.firstName)||s.firstName;
      const newLast=prompt('Magaca Dambe:',s.lastName)||s.lastName;
      const newEmail=prompt('Email:',s.email)||s.email;
      const newPhone=prompt('Taleefan:',s.phone)||s.phone;
      const newClass=prompt('Fasal:',s.className)||s.className;
      students[idx]={...s,firstName:newFirst,lastName:newLast,email:newEmail,phone:newPhone,className:newClass};
      saveStudents(students);
      renderStudents();
    }

    function addMonthlyPayment(idx){
      const students=loadStudents();
      const s=students[idx];
      const amount=Number(prompt('Enter payment amount (USD):','50'));
      if(amount&&amount>0){
        if(!s.payments) s.payments=[];
        s.payments.push({amount,date:new Date().toISOString()});
        students[idx]=s;
        saveStudents(students);
        renderStudents();
      }
    }

    function renderStudentSelect(){
      const select=document.getElementById('studentSelect');
      const students=loadStudents();
      select.innerHTML=students.map((s,idx)=>`<option value="${idx}">${s.firstName} ${s.lastName}</option>`).join('');
    }

    document.getElementById('paymentForm').addEventListener('submit',function(e){
      e.preventDefault();
      const idx=document.getElementById('studentSelect').value;
      const date=document.getElementById('paymentDate').value;
      const amount=Number(document.getElementById('paymentAmount').value);
      if(!date||!amount) return;
      const students=loadStudents();
      const s=students[idx];
      if(!s.payments) s.payments=[];
      s.payments.push({amount,date});
      students[idx]=s;
      saveStudents(students);
      renderStudents();
      renderPayments();
      this.reset();
    });

    function renderPayments(filter={}) {
      const students = loadStudents();
      const container = document.getElementById('paymentsList');
      let rows = [];
      students.forEach(s=>{
        (s.payments||[]).forEach(p=>{
          rows.push({name:s.firstName+' '+s.lastName,amount:p.amount,date:p.date});
        });
      });
      if(filter.name) rows=rows.filter(r=>r.name.toLowerCase().includes(filter.name.toLowerCase()));
      if(filter.date) rows=rows.filter(r=>r.date.startsWith(filter.date));
      if(!rows.length){ container.innerHTML='<div class="small-muted">Ma jiro lacag la qabtay</div>'; return; }
      let html='<table class="table table-bordered"><thead><tr><th>Magaca</th><th>Taariikh</th><th>Lacag (USD)</th></tr></thead><tbody>';
      rows.forEach(r=>html+=`<tr><td>${r.name}</td><td>${r.date}</td><td>$${r.amount}</td></tr>`);
      html+='</tbody></table>';
      container.innerHTML=html;
    }

    function filterPayments() {
      const name=document.getElementById('searchName').value.trim();
      const date=document.getElementById('searchDate').value;
      renderPayments({name,date});
    }

    function filterInvoice(){
      const name=document.getElementById('invoiceSearchName').value.trim().toLowerCase();
      const start=document.getElementById('invoiceStartDate').value;
      const end=document.getElementById('invoiceEndDate').value;
      const students=loadStudents();
      let selected=students.filter(s=>(s.firstName+' '+s.lastName).toLowerCase().includes(name));
      let rows=[];
      selected.forEach(s=>{
        (s.payments||[]).forEach(p=>{
          let ok=true;
          if(start && p.date<start) ok=false;
          if(end && p.date>end) ok=false;
          if(ok) rows.push({name:s.firstName+' '+s.lastName,amount:p.amount,date:p.date});
        });
      });
      const container=document.getElementById('invoiceContent');
      if(!rows.length){ container.innerHTML='<div class="small-muted">Ma jiro lacag la qabtay</div>'; return; }

      let html='<table style="width:100%;background:#f0f8ff"><thead><tr style="background:#cce5ff"><th>Magaca</th><th>Taariikh</th><th>Lacag (USD)</th></tr></thead><tbody>';
      rows.forEach((r,i)=>{
        const bg=i%2===0?'#e6f2ff':'#ffffff';
        html+=`<tr style="background:${bg}"><td>${r.name}</td><td>${r.date}</td><td>$${r.amount}</td></tr>`;
      });
      html+='</tbody></table>';
      const total=rows.reduce((a,b)=>a+b.amount,0);
      html+=`<div class="fw-bold mt-2 p-2" style="background:#d9ecff; width:150px;">Total Paid: $${total}</div>`;
      container.innerHTML=html;
    }

    async function downloadInvoicePDF(){
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF();
      const container=document.getElementById('invoiceContent');
      doc.setFontSize(16);
      doc.text('Sahal Primary & Secondary School',20,20);

      const rows=container.querySelectorAll('table tbody tr');
      const colWidths=[70,50,50];
      let y=30;

      doc.setFillColor(204,229,255);
      doc.rect(15,y-5,170,10,'F');
      doc.setFontSize(12);
      doc.text('Magaca',17,y);
      doc.text('Taariikh',87,y);
      doc.text('Lacag (USD)',137,y);
      y+=10;

      rows.forEach((tr,i)=>{
        const cols=tr.querySelectorAll('td');
        const bgColor=i%2===0?[230,242,255]:[255,255,255];
        doc.setFillColor(...bgColor);
        doc.rect(15,y-5,170,10,'F');

        let x=15;
        colWidths.forEach((w,idx)=>{
          doc.setDrawColor(200);
          doc.rect(x,y-5,w,10);
          x+=w;
        });

        doc.setTextColor(0);
        doc.text(cols[0].textContent,17,y);
        doc.text(cols[1].textContent,87,y);
        doc.text(cols[2].textContent,137,y);
        y+=10;
      });

      const totalDiv=container.querySelector('.fw-bold');
      if(totalDiv){
        doc.setFillColor(210,236,255);
        doc.rect(15,y-5,170,10,'F');
        doc.setDrawColor(200);
        doc.rect(15,y-5,170,10);
        doc.text(totalDiv.textContent,17,y);
      }

      doc.save('invoice.pdf');
    }

    document.querySelectorAll('a.nav-link').forEach(link=>{
      link.addEventListener('click',function(e){
        e.preventDefault();
        const section=this.getAttribute('data-section');
        document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
        document.getElementById(section).classList.add('active');
      });
    });

    renderStudents();
    renderPayments();
  </script>
</body>
</html>
